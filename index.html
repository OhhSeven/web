<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #0b0b0d;
    --panel: #0f1113;
    --muted: #98a0aa;
    --accent: #10a37f;
    --glass: rgba(255,255,255,0.02);
    --bubble-ai: #111315;
    --bubble-user: linear-gradient(90deg,#2f80ed,#2563eb);
    --danger: #ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#e6eef8;background:var(--bg);}

  .app {
    width:100%;
    max-width:1300px;
    height:92vh;
    margin:20px auto;
    display:grid;
    grid-template-columns: 320px 1fr;
    gap:18px;
  }

  .sidebar {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03);
    border-radius:12px;
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:hidden;
  }
  .sb-top { display:flex; align-items:flex-start; gap:10px; justify-content:space-between; }
  .brand { display:flex; gap:10px; align-items:center; }
  .logo { width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#111827,#374151);display:flex;align-items:center;justify-content:center;font-weight:700;color:#9ae6b4;box-shadow:0 6px 18px rgba(2,6,23,0.6); font-size:18px; }
  .sb-title { font-weight:700; font-size:16px; }
  .sb-sub { font-size:12px; color:var(--muted); margin-top:3px; }

  .chat-list { overflow:auto; padding:6px 2px; display:flex; flex-direction:column; gap:8px; margin-top:6px; }

  .chat-item {
    display:flex;
    gap:10px;
    align-items:center;
    padding:10px;
    border-radius:10px;
    cursor:pointer;
    transition: background .12s ease;
  }
  .chat-item:hover { background: rgba(255,255,255,0.012); }
  .chat-item.active { background: rgba(255,255,255,0.02); }

  .chat-item .meta {
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:0;
  }
  .chat-title { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .chat-snippet { font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:160px; }
  .chat-right { margin-left:auto; display:flex; gap:6px; align-items:center; }

  .sb-bottom { margin-top:auto; display:flex; gap:8px; align-items:center; justify-content:space-between; }

  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03);
    border-radius:12px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  .panel-header {
    display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid rgba(255,255,255,0.02);
  }
  .panel-title { font-weight:700; font-size:15px; }
  .panel-sub { color:var(--muted); font-size:13px; margin-top:2px; }

  .chat-area { padding:18px; overflow:auto; display:flex; flex-direction:column; gap:12px; flex:1; background:linear-gradient(180deg, rgba(255,255,255,0.004), transparent); }

  .msg-row { display:flex; gap:12px; align-items:flex-start; max-width:82%; }
  .msg-row.user { margin-left:auto; justify-content:flex-end; }
  .avatar { width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:white; flex:0 0 40px; }
  .avatar.user { background:linear-gradient(90deg,#2f80ed,#2563eb); }
  .avatar.ai { background:linear-gradient(180deg,#111827,#0b1220); color:#9ae6b4; border:1px solid rgba(255,255,255,0.02); }

  .bubble { padding:12px 14px; border-radius:12px; background:var(--bubble-ai); color:#dfffe7; line-height:1.5; font-size:14px; box-shadow:0 8px 24px rgba(2,6,23,0.5); white-space:pre-wrap; }
  .bubble.user { background:var(--bubble-user); color:white; border-bottom-right-radius:4px; }

  .composer {
    padding:12px; border-top:1px solid rgba(255,255,255,0.02); display:flex; gap:8px; align-items:center;
    background:linear-gradient(0deg, rgba(255,255,255,0.01), transparent);
  }

  .composer .input-wrap {
    flex:1; display:flex; align-items:center; gap:8px; background:#0b0f13; border-radius:14px; padding:8px 10px;
    border:1px solid rgba(255,255,255,0.02);
  }
  .text-input {
    flex:1; background:transparent; border:none; outline:none; color:#e6eef8; font-size:15px; padding:8px;
    resize:none; min-height:38px; max-height:160px;
  }

  .send-btn {
    background:linear-gradient(180deg,#10a37f,#0e8a6a); border:none; color:white; width:48px; height:48px;border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer;
  }
  .send-btn:disabled { opacity:0.5; cursor:not-allowed; }
  .stop-btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:8px 10px; border-radius:10px; cursor:pointer; }
  .small { font-size:13px; color:var(--muted) }

  .help { padding:10px 18px; font-size:13px; color:var(--muted); border-top:1px solid rgba(255,255,255,0.02); }

  @media (max-width:880px){
    .app { grid-template-columns: 1fr; height:95vh; max-width:980px; }
    .sidebar { order:2; display:none; } 
  }

  .chat-area::-webkit-scrollbar, .chat-list::-webkit-scrollbar { height:8px; width:8px; }
  .chat-area::-webkit-scrollbar-thumb, .chat-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.03); border-radius:8px; }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Ollama Chat">
    <aside class="sidebar" id="sidebar">
      <div class="sb-top">
        <div class="brand" style="align-items:flex-start">
          <div class="logo">AI</div>
          <div>
            <div class="sb-title">I Made an AI chat because I was bored</div>
            <div class="sb-sub" id="sidebarSummary">Your conversations (local)</div>
          </div>
        </div>
      </div>

      <div class="chat-list" id="chatList" role="list"></div>

      <div class="sb-bottom">
        <div style="display:flex;gap:8px;">
          <button id="exportAll" class="stop-btn">Export All</button>
        </div>
        <button id="newChatBtn" class="new-btn" style="background:#2b3440;border-radius:10px;padding:8px 10px;border:none;color:#e6eef8;cursor:pointer;font-weight:600;">+ New chat</button>
      </div>
    </aside>

    <main class="panel" role="main">
      <div class="panel-header">
        <div>
          <div class="panel-title" id="panelTitle">New Chat</div>
          <div class="panel-sub" id="panelSub">Chat with your local Ollama model</div>
        </div>
        <div class="row">
          <button id="clearBtn" class="stop-btn">Clear</button>
          <button id="downloadBtn" class="stop-btn">Export</button>
        </div>
      </div>

      <section class="chat-area" id="chatArea" aria-live="polite"></section>

      <div class="composer">
        <div class="input-wrap">
          <textarea id="inputField" class="text-input" rows="1" placeholder="Send a message — Enter to send, Shift+Enter for newline"></textarea>
        </div>
        <button id="stopBtn" class="stop-btn" style="display:none">Stop</button>
        <button id="sendBtn" class="send-btn" title="Send (Enter)">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2l-7 20 2-9 9-9z"></path></svg>
        </button>
      </div>

      <div class="help">Tip: Sidebar stores chats in your browser. Press <strong>Enter</strong> to send, <strong>Shift+Enter</strong> for newline.</div>
    </main>
  </div>

<script>
(() => {

  const OLLAMA_URL = "http://147.93.190.247:11434/api/generate"; // change if needed
  const MODEL = "phi3:mini";
  const SYSTEM_PROMPT = "You are a friendly, concise AI assistant. Answer helpfully and clearly. Do not include headings or developer instructions. Keep responses short and natural.";


  const chatArea = document.getElementById("chatArea");
  const inputField = document.getElementById("inputField");
  const sendBtn = document.getElementById("sendBtn");
  const stopBtn = document.getElementById("stopBtn");
  const newChatBtn = document.getElementById("newChatBtn");
  const chatListEl = document.getElementById("chatList");
  const panelTitle = document.getElementById("panelTitle");
  const panelSub = document.getElementById("panelSub");
  const clearBtn = document.getElementById("clearBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const exportAllBtn = document.getElementById("exportAll");
  const sidebarSummary = document.getElementById("sidebarSummary");

  let controller = null;
  let isGenerating = false;
  let chats = [];
  let activeChatId = null;

  const STORAGE_KEY = "ollama_chat_chats_v2";

  // ---------------------
  // UTILITIES
  // ---------------------
  function uid() { return 'c_' + Math.random().toString(36).slice(2,9); }
  function nowTs(){ return new Date().toISOString(); }

  function saveChats() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(chats)); }
    catch(e){ console.warn("save failed", e); }
  }
  function loadChats(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      return JSON.parse(raw);
    } catch(e){ console.warn("load failed", e); return []; }
  }

  function setGenerating(v){
    isGenerating = v;
    inputField.disabled = v;
    sendBtn.disabled = v;
    stopBtn.style.display = v ? "inline-block" : "none";
    if (!v) inputField.focus();
  }

  function chatTitleFromMessages(messages){
    if (!messages || !messages.length) return "New chat";

    const firstUser = messages.find(m => m.role === "user");
    const txt = firstUser ? firstUser.content : messages[0].content;

    return txt.length > 36 ? txt.slice(0,36) + "…" : txt;
  }

  function chatSnippet(messages){
    if (!messages || !messages.length) return "No messages yet";
    const last = messages[messages.length-1];
    const text = last.content.replace(/\s+/g,' ').trim();
    return text.length > 60 ? text.slice(0,60) + "…" : text;
  }


  function addChatToListUI(){
    chatListEl.innerHTML = "";
    for(const c of chats){
      const div = document.createElement("div");
      div.className = "chat-item" + (c.id === activeChatId ? " active" : "");
      div.setAttribute("role","listitem");
      div.onclick = () => { openChat(c.id); };

      const meta = document.createElement("div");
      meta.className = "meta";
      const title = document.createElement("div");
      title.className = "chat-title";
      title.textContent = c.title || chatTitleFromMessages(c.messages);
      const snippet = document.createElement("div");
      snippet.className = "chat-snippet";
      snippet.textContent = chatSnippet(c.messages);

      meta.appendChild(title);
      meta.appendChild(snippet);

      const right = document.createElement("div");
      right.className = "chat-right";
      const ts = document.createElement("div");
      ts.className = "chat-meta";
      ts.style.fontSize = "11px";
      ts.style.color = "var(--muted)";
      ts.textContent = c.messages.length ? new Date(c.messages[c.messages.length-1].ts).toLocaleString() : "";
      const exportBtn = document.createElement("button");
      exportBtn.className = "stop-btn";
      exportBtn.style.padding = "6px 8px";
      exportBtn.textContent = "Export";
      exportBtn.onclick = (ev)=>{ ev.stopPropagation(); exportChat(c.id); };
      const delBtn = document.createElement("button");
      delBtn.className = "stop-btn";
      delBtn.style.padding = "6px 8px";
      delBtn.textContent = "Delete";
      delBtn.onclick = (ev)=>{ ev.stopPropagation(); deleteChat(c.id); };

      right.appendChild(ts);
      right.appendChild(exportBtn);
      right.appendChild(delBtn);

      div.appendChild(meta);
      div.appendChild(right);
      chatListEl.appendChild(div);
    }
  }

  function createNewChat(title){
    const id = uid();
    const chat = { id, title: title || "New chat", messages: [] };
    chats.unshift(chat);
    activeChatId = id;
    saveChats();
    refreshUI();
  }

  function deleteChat(id){
    const idx = chats.findIndex(c=>c.id===id);
    if (idx===-1) return;
    if (confirm("Delete this chat?")) {
      chats.splice(idx,1);
      if (chats.length) activeChatId = chats[0].id; else activeChatId = null;
      saveChats(); refreshUI();
    }
  }

  function exportChat(id){
    const c = chats.find(x=>x.id===id); if(!c) return;
    const blob = new Blob([JSON.stringify(c, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = (c.title||c.id)+".json"; a.click(); URL.revokeObjectURL(url);
  }

  function exportAll(){
    const blob = new Blob([JSON.stringify(chats, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "ollama_chats.json"; a.click(); URL.revokeObjectURL(url);
  }


  function openChat(id){
    const c = chats.find(x=>x.id===id);
    if (!c) return;
    activeChatId = id;
    renderActiveChat();
    addChatToListUI();
    updateSidebarSummary();
  }

  function renderActiveChat(){
    chatArea.innerHTML = "";
    const c = chats.find(x=>x.id===activeChatId);
    if(!c){ panelTitle.textContent = "New Chat"; panelSub.textContent = "Chat with your local model"; return; }
    panelTitle.textContent = c.title || chatTitleFromMessages(c.messages);
    panelSub.textContent = "Local model: " + MODEL;

    for(const m of c.messages){
      const row = createMessageRow(m.role, m.content);
      chatArea.appendChild(row);
    }
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function createMessageRow(role, text){
    const wrapper = document.createElement("div");
    wrapper.className = "msg-row " + (role==="user" ? "user" : "ai");
    const avatar = document.createElement("div");
    avatar.className = "avatar " + (role==="user" ? "user" : "ai");
    avatar.textContent = (role==="user" ? "Y" : "AI");
    const bubble = document.createElement("div");
    bubble.className = "bubble " + (role==="user" ? "user" : "ai");
    bubble.textContent = text;
    if (role === "ai") {
      wrapper.appendChild(avatar);
      wrapper.appendChild(bubble);
    } else {
      wrapper.appendChild(bubble);
      wrapper.appendChild(avatar);
    }
    return wrapper;
  }


  chats = loadChats();
  if (!chats || !chats.length){ createNewChat("New chat"); } else { activeChatId = chats[0].id; refreshUI(); }

  function refreshUI(){ addChatToListUI(); renderActiveChat(); updateSidebarSummary(); }

  function updateSidebarSummary(){
    const c = chats.find(x=>x.id===activeChatId);
    if (!c || !c.messages.length) sidebarSummary.textContent = "Your conversations (local)";
    else {
      const last = c.messages[c.messages.length-1];
      const time = new Date(last.ts).toLocaleString();
      sidebarSummary.textContent = `${c.title || chatTitleFromMessages(c.messages)} • last: ${time}`;
    }
  }


  function getPrompt(newUserMessage){
    const c = chats.find(x=>x.id===activeChatId);
    const maxTurns = 8;
    const parts = [SYSTEM_PROMPT, "\nConversation:"];
    if (c && c.messages.length){
      const recent = c.messages.slice(-maxTurns*2);
      for (const m of recent){
        parts.push((m.role==="user" ? "User: " : "Assistant: ") + m.content);
      }
    }
    parts.push("User: " + newUserMessage);
    parts.push("Assistant:");
    return parts.join("\n");
  }

  async function streamAI(userText, aiBubble){
    const payload = {
      model: MODEL,
      prompt: getPrompt(userText),
      max_output_tokens: 512,
      stream: true
    };

    controller = new AbortController();
    setGenerating(true);

    try {
      const resp = await fetch(OLLAMA_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
        signal: controller.signal
      });

      if (!resp.ok) {
        const body = await resp.text().catch(()=>"");
        throw new Error("Server returned " + resp.status + (body ? (": "+body) : ""));
      }

      const reader = resp.body.getReader();
      const dec = new TextDecoder();
      let partial = "";
      while(true){
        const {done, value} = await reader.read();
        if (done) break;
        partial += dec.decode(value, {stream:true});
        const lines = partial.split("\n");
        partial = lines.pop();
        for(const line of lines){
          if (!line.trim()) continue;
          try {
            const j = JSON.parse(line);
            if (j.response) {
              aiBubble.textContent += j.response;
              chatArea.scrollTop = chatArea.scrollHeight;
            }
          } catch(e){
            aiBubble.textContent += line;
            chatArea.scrollTop = chatArea.scrollHeight;
          }
        }
      }
      if (partial.trim()){
        try{ const j = JSON.parse(partial); if (j.response) aiBubble.textContent += j.response; } catch(e){}
      }
      const final = aiBubble.textContent.trim();
      const c = chats.find(x=>x.id===activeChatId);
      c.messages.push({role:"assistant", content: final, ts: nowTs()});
      saveChats();
      renderActiveChat();
    } finally {
      controller = null;
      setGenerating(false);
      updateSidebarSummary();
    }
  }


  sendBtn.addEventListener("click", ()=> {
    if (isGenerating) return;
    const text = inputField.value.trim();
    if (!text) return;
    sendMessage(text);
  });

  inputField.addEventListener("keydown", (e)=>{
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      if (!isGenerating) sendBtn.click();
    }
  });

  stopBtn.addEventListener("click", ()=>{
    if (controller){
      controller.abort();
      controller = null;
      setGenerating(false);
    }
  });

  newChatBtn.addEventListener("click", ()=>{
    createNewChat("New chat");
    refreshUI();
  });

  clearBtn.addEventListener("click", ()=>{
    const c = chats.find(x=>x.id===activeChatId);
    if (!c) return;
    if (confirm("Clear messages in this chat?")){
      c.messages = [];
      saveChats();
      renderActiveChat();
    }
  });

  downloadBtn.addEventListener("click", ()=>{
    const c = chats.find(x=>x.id===activeChatId);
    if (!c) return;
    exportChat(activeChatId);
  });

  exportAllBtn.addEventListener("click", ()=> exportAll());

  function sendMessage(text){
    const c = chats.find(x=>x.id===activeChatId);
    if (!c) return;
    c.messages.push({role:"user", content:text, ts: nowTs()});
    saveChats();
    renderActiveChat();
    inputField.value = "";
    inputField.focus();
    const aiRow = createMessageRow("assistant", "");
    chatArea.appendChild(aiRow);
    chatArea.scrollTop = chatArea.scrollHeight;
    streamAI(text, aiRow.querySelector(".bubble"));
  }

  function createMessageRow(role, initialText){
    const wrapper = document.createElement("div");
    wrapper.className = "msg-row " + (role==="user" ? "user" : "ai");
    const avatar = document.createElement("div");
    avatar.className = "avatar " + (role==="user" ? "user" : "ai");
    avatar.textContent = (role==="user" ? "Y" : "AI");
    const bubble = document.createElement("div");
    bubble.className = "bubble " + (role==="user" ? "user" : "ai");
    bubble.textContent = initialText || "";
    if (role === "ai") {
      wrapper.appendChild(avatar);
      wrapper.appendChild(bubble);
    } else {
      wrapper.appendChild(bubble);
      wrapper.appendChild(avatar);
    }
    return wrapper;
  }

  refreshUI();
})();
</script>
</body>
</html>
